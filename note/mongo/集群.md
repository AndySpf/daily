官方文档：https://docs.mongodb.com/v4.0
## mongo集群 
#### 集群的几种模式
1. 副本集（Replica Set）
2. 主备（Master-Slave） *mongo4.0+不再支持,主从配置转换为副本集可参考https://docs.mongodb.com/v4.0/core/master-slave/index.html*
3. 切片（Sharding） 基于副本集的性能扩展机制   

#### 副本集的几种架构模式:   
**集群建议成员数量为奇数个，如果承担数据的成员不够，可以添加最小资源的仲裁节点（仅做投票，不存储数据）凑够奇个。**  
 1.单数据中心  
例如，对于三成员副本集，可能的组成为:
+ 一主两备   
交互关系如下:
 ![示意图](https://docs.mongodb.com/v4.0/_images/replica-set-primary-with-two-secondaries.bakedsvg.svg "交互关系")
如果主节点发生故障,则备节点会开始选举，选出新的主节点以保证业务正常，当旧的主节点从新恢复正常后可以重新加入到集群中:
 ![示意图](https://docs.mongodb.com/v4.0/_images/replica-set-trigger-election.bakedsvg.svg "交互关系")

+ 一主一备一仲裁
 ![示意图](https://docs.mongodb.com/v4.0/_images/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg "交互关系")
如果主节点发生故障，则备机会被选举为新的主节点：
 ![示意图](https://docs.mongodb.com/v4.0/_images/replica-set-w-arbiter-trigger-election.bakedsvg.svg "交互关系")



2.多数据中心        
例如，对于三成员副本集，成员的一些可能的分布包括:      
1. 两个数据中心：数据中心1分布两个成员，数据中心2分布一个成员。如果副本集的成员之一是仲裁者，则将仲裁者与承载数据的成员一起分给数据中心1。  
   + 如果数据中心1发生故障，则副本集将变为只读。   
   + 如果数据中心2发生故障，则副本集将保持可写状态，因为数据中心1中的成员可以举行选举。    
2. 三个数据中心：一个成员给到数据中心1，另一个成员给到数据中心2，最后一个成员给数据中心3。    
   + 如果任何数据中心发生故障，副本集将保持可写状态，因为其余成员可以举行选举。
> 注意：在两个数据中心之间分布副本集成员可提供优于单个数据中心的好处。  
> 在两个数据中心分布中，如果其中一个数据中心发生故障，则与单个数据中心分发不同，该数据仍可读取。如果具有少数成员的数据中心发生故障，则副本集仍然可以同时执行写操作和读操作。但是，如果拥有大多数成员的数据中心发生故障，则副本集将变为只读。   
> 对于配置服务器副本集，最佳实践是分布在三个（或更多，取决于成员的数量）中心中。如果可能，请在至少三个数据中心中分配成员。如果第三个数据中心的成本过高，则一种分配可能性是在两个数据中心之间平均分配数据承载成员，并将其余成员（仲裁员，以确保成员数量奇数）存储在该数据中心中。如果您公司的政策允许的话
---
#### 搭建副本集：

    移除副本集成员 rs.remove("192.168.29.100:27017")
---
#### 选举:    
1. 可以通过设置priority来提高某个结点的优先级，让其优先被选举为主节点，priority为0则不能被选举，如仲裁节点。
2. 每一次心跳过后任何一个节点都企图将主节点降级，发起选举的条件：
   + secondary发现自己的优先级比primary高
   + secondary发现集群中目前没有primary
   + 重新加载配置会强制让当前主节点降级，同时短暂关闭当前所有连接，rs.reconfig()
   
3. primary自动降级条件
   + 不能连通集群内的大部分（n/2 + 1）节点

4. 可以被选举为主节点的条件：
   + 能与集群内大部分节点建立通信
   + 不能是仲裁节点
   + priority必须大于0   
   如果满足以上条件，则向集群内所有存活节点发送选举申请。  
   **投票节点（vote=1）最多为7个，投票节点的priority必须大于0，没有投票权的节点priority必须等于0**   
   如果可以收到集群内大部分节点的赞成票，则当选；   
   如果有两个节点收到相同票数，或者没有超过半数票的节点，则在1s内重新开始选举。
   
